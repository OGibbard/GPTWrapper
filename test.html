<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Canvas</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the app */
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* Prevent scrolling of the entire page */
        }

        /* A subtle dot-grid background for the canvas to give it a whiteboard feel */
        #canvas {
            background-color: #f8fafc; /* slate-50 */
            background-image: radial-gradient(#d1d5db 1px, transparent 0); /* gray-300 */
            background-size: 20px 20px;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            cursor: pointer;
        }

        /* Styling for the draggable text boxes */
        .textbox {
            position: absolute;
            padding: 12px;
            border-radius: 8px;
            background-color: #fef08a; /* yellow-200 */
            border: 1px solid #facc15; /* yellow-400 */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            cursor: move;
            min-width: 150px;
            min-height: 80px;
            resize: both;
            overflow: hidden;
        }
        
        .textbox:focus-within {
             outline: 2px solid #3b82f6; /* blue-500 */
             outline-offset: 2px;
        }

        /* The actual editable area within the textbox */
        .textbox-content {
            width: 100%;
            height: 100%;
            outline: none;
            cursor: text;
        }
        
        /* Hide scrollbars on resizable textboxes for a cleaner look */
        .textbox::-webkit-resizer {
            display: none;
        }

    </style>
</head>
<body class="bg-slate-100">

    <!-- Login Screen: Shown initially, hidden after authentication -->
    <div id="login-screen" class="flex items-center justify-center h-screen">
        <div class="text-center p-8 bg-white rounded-lg shadow-xl max-w-sm w-full">
            <h1 class="text-3xl font-bold text-slate-800 mb-2">Collaborative Canvas</h1>
            <p class="text-slate-600 mb-6">Your personal space to capture ideas. Log in to continue.</p>
            <button id="login-button" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300">
                Enter Canvas
            </button>
        </div>
    </div>

    <!-- Main App Screen: Hidden initially, shown after authentication -->
    <div id="app-screen" class="hidden h-screen w-screen">
        <!-- Header bar -->
        <header class="absolute top-0 left-0 right-0 z-10 p-2 bg-white/70 backdrop-blur-sm shadow-sm">
             <div class="flex items-center justify-between max-w-7xl mx-auto">
                <div class="flex items-center space-x-3">
                     <span class="font-bold text-slate-800">Collaborative Canvas</span>
                     <span class="text-xs bg-slate-200 text-slate-600 px-2 py-1 rounded-full">Double-click to add a note</span>
                </div>
                <div class="text-right">
                    <p class="text-xs text-slate-500">Your User ID:</p>
                    <p id="user-id-display" class="text-xs text-slate-800 font-mono select-all"></p>
                </div>
            </div>
        </header>
        
        <!-- The main canvas area where textboxes will be added -->
        <main id="canvas-container" class="relative w-full h-full pt-16">
             <div id="canvas"></div>
        </main>
    </div>

    <!-- Firebase and App Logic -->
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-analytics.js";
      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries

      // Your web app's Firebase configuration
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      const firebaseConfig = {
        apiKey: "AIzaSyCWTkzSO0ILfUPzFoGQuA-rhCKtVQ5SxDU",
        authDomain: "gptwrapper-1053f.firebaseapp.com",
        projectId: "gptwrapper-1053f",
        storageBucket: "gptwrapper-1053f.firebasestorage.app",
        messagingSenderId: "461455890783",
        appId: "1:461455890783:web:f120d9065135c69884feea",
        measurementId: "G-TGMVDZ2MTT"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);

      // Import necessary functions from the Firebase SDK
      import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import { getFirestore, collection, doc, setDoc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // --- DOM Element References ---
      const loginScreen = document.getElementById('login-screen');
      const appScreen = document.getElementById('app-screen');
      const loginButton = document.getElementById('login-button');
      const canvas = document.getElementById('canvas');
      const userIdDisplay = document.getElementById('user-id-display');

      // --- App State ---
      let db, auth;
      let userId = null;
      let textboxesCollectionRef = null;
      let unsubscribeFromTextboxes = null;

      // --- Dragging State ---
      let isDragging = false;
      let draggedElement = null;
      let offsetX, offsetY;

      // --- Firebase Initialization and Authentication ---
      
      // Use global variables provided by the environment for configuration.
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'collab-canvas-default';
      const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

      /**
       * Initializes the Firebase app, gets auth and firestore instances.
       */
      function initializeFirebase() {
          try {
              auth = getAuth(app);
              db = getFirestore(app);
          } catch (error) {
              console.error("Error initializing Firebase:", error);
              alert("Could not connect to the service. Please refresh the page.");
          }
      }
      
      /**
       * Sets up the authentication state listener. This is the main entry point
       * for the application logic after a user's auth state is known.
       */
      function setupAuthListener() {
          onAuthStateChanged(auth, (user) => {
              if (user) {
                  // User is signed in.
                  userId = user.uid;
                  userIdDisplay.textContent = userId;

                  // Set up the Firestore collection reference for this specific user.
                  // Data is stored privately for each user.
                  textboxesCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'textboxes');
                  
                  // Show the main app and hide the login screen
                  loginScreen.classList.add('hidden');
                  appScreen.classList.remove('hidden');

                  // Start listening for real-time updates to textboxes
                  listenForTextboxes();
              } else {
                  // User is signed out.
                  userId = null;
                  if (unsubscribeFromTextboxes) {
                      unsubscribeFromTextboxes(); // Stop listening to old data
                  }
                  canvas.innerHTML = ''; // Clear canvas
                  loginScreen.classList.remove('hidden');
                  appScreen.classList.add('hidden');
              }
          });
      }

      /**
       * Handles the login process.
       */
      async function handleLogin() {
          try {
               if (initialAuthToken) {
                  await signInWithCustomToken(auth, initialAuthToken);
              } else {
                  await signInAnonymously(auth);
              }
          } catch (error) {
               console.error("Authentication Error: ", error);
               alert("Could not sign you in. Please try again.");
          }
      }
      
      loginButton.addEventListener('click', handleLogin);
      
      // --- Firestore Real-time Data Handling ---

      /**
       * Listens for real-time changes (add, modify, remove) to the textboxes
       * in the user's private collection and updates the UI accordingly.
       */
      function listenForTextboxes() {
          if (unsubscribeFromTextboxes) {
               unsubscribeFromTextboxes();
          }
          unsubscribeFromTextboxes = onSnapshot(textboxesCollectionRef, (snapshot) => {
              snapshot.docChanges().forEach((change) => {
                  const docId = change.doc.id;
                  const data = change.doc.data();
                  
                  if (change.type === "added") {
                      renderTextbox(docId, data);
                  }
                  if (change.type === "modified") {
                      updateTextboxInDOM(docId, data);
                  }
                  if (change.type === "removed") {
                      const el = document.getElementById(docId);
                      if (el) el.remove();
                  }
              });
          });
      }
      
      /**
       * Saves or updates a textbox's data in Firestore.
       * @param {string} id - The document ID of the textbox.
       * @param {object} data - The data to save { text, x, y }.
       */
      async function saveTextboxData(id, data) {
          try {
              const docRef = doc(textboxesCollectionRef, id);
              // Use setDoc with merge to create or update, preventing overwrite
              await setDoc(docRef, data, { merge: true });
          } catch(error) {
              console.error("Error saving textbox: ", error);
          }
      }
      
      // --- DOM Manipulation & UI Logic ---

      /**
       * Renders a single textbox element on the canvas.
       * @param {string} id - The unique ID for the textbox element.
       * @param {object} data - The textbox data { text, x, y }.
       */
      function renderTextbox(id, data) {
          const textbox = document.createElement('div');
          textbox.id = id;
          textbox.className = 'textbox';
          textbox.style.left = `${data.x}px`;
          textbox.style.top = `${data.y}px`;

          const content = document.createElement('div');
          content.className = 'textbox-content';
          content.contentEditable = 'true';
          content.innerText = data.text;
          
          textbox.appendChild(content);

          // Save text changes when the user clicks away
          content.addEventListener('blur', () => {
              saveTextboxData(id, { text: content.innerText });
          });
          
          // Add mousedown listener to handle dragging
          textbox.addEventListener('mousedown', startDrag);

          canvas.appendChild(textbox);
      }
      
      /**
       * Updates an existing textbox in the DOM if it was changed by another client.
       * @param {string} id - The ID of the textbox element to update.
       * @param {object} data - The updated textbox data.
       */
      function updateTextboxInDOM(id, data) {
          const textbox = document.getElementById(id);
          if (!textbox || textbox === draggedElement) return; // Don't update if it doesn't exist or is being dragged
          
          textbox.style.left = `${data.x}px`;
          textbox.style.top = `${data.y}px`;
          
          const content = textbox.querySelector('.textbox-content');
          if (content && content.innerText !== data.text) {
              content.innerText = data.text;
          }
      }
      
      /**
       * Creates a new textbox when the user double-clicks on the canvas.
       */
      canvas.addEventListener('dblclick', (e) => {
          // Prevent creating a note on top of an existing one
          if (e.target !== canvas) return;
          
          const newId = crypto.randomUUID();
          const newData = {
              text: 'New Note âœ¨',
              x: e.clientX - canvas.getBoundingClientRect().left - 75, // Center the note on cursor
              y: e.clientY - canvas.getBoundingClientRect().top - 40,
          };
          saveTextboxData(newId, newData);
      });

      // --- Drag and Drop Logic ---

      function startDrag(e) {
          // Only drag with the left mouse button, and not when clicking on the content area
          if (e.button !== 0 || e.target.classList.contains('textbox-content')) {
              return;
          }
          e.preventDefault();
          
          isDragging = true;
          draggedElement = e.currentTarget; // The .textbox div
          
          // Calculate the offset from the mouse pointer to the element's top-left corner
          offsetX = e.clientX - draggedElement.offsetLeft;
          offsetY = e.clientY - draggedElement.offsetTop;
          
          document.addEventListener('mousemove', drag);
          document.addEventListener('mouseup', stopDrag);
      }

      function drag(e) {
          if (!isDragging) return;
          
          const newX = e.clientX - offsetX;
          const newY = e.clientY - offsetY;
          
          draggedElement.style.left = `${newX}px`;
          draggedElement.style.top = `${newY}px`;
      }

      function stopDrag() {
          if (!isDragging) return;
          
          isDragging = false;
          
          // Get final position and save to Firestore
          const finalX = parseInt(draggedElement.style.left, 10);
          const finalY = parseInt(draggedElement.style.top, 10);
          
          saveTextboxData(draggedElement.id, { x: finalX, y: finalY });
          
          draggedElement = null;
          document.removeEventListener('mousemove', drag);
          document.removeEventListener('mouseup', stopDrag);
      }

      // --- App Entry Point ---
      initializeFirebase();
      setupAuthListener();

    </script>
</body>
</html>